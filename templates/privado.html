{% extends "base.html" %}
{% block titulo %}Zona privada{% endblock %}

{% block contenido %}
<h1>üîê Archivos privados</h1>

<h2>Filtrar por etiqueta</h2>
<form action="/filtrar_privado" method="GET">
  <input type="text" name="etiqueta" placeholder="ej: selfie, escaneos, .pdf" required>
  <button type="submit">Buscar</button>
</form>

{% if archivos %}
  <style>
    .galeria {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .tarjeta {
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 6px;
      background: #4c4c4c;
      text-align: center;
      font-size: 0.9em;
    }
    .tarjeta img {
      max-width: 100%;
      max-height: 120px;
      object-fit: contain;
      margin-bottom: 10px;
    }
    .tarjeta small {
      display: block;
      color: #666;
    }
  </style>

<a href="/upload_privado">‚ûï Subir nuevo archivo privado</a>
<br><br>

  <div class="galeria">
    {% for archivo in archivos %}
      <div class="tarjeta">
        {% if archivo.tipo.startswith('image/') %}
          {% set thumb = 'Tilok/thumb_' + archivo.nombre + '.jpg' %}
          <a href="/archivo/{{ archivo.id }}">
            <img src="/media/{{ thumb }}" alt="Miniatura">
          </a>
        {% elif archivo.tipo.startswith('video/') %}
          {% set thumb = 'Tilok/thumb_' + archivo.nombre + '.jpg' %}
          <a href="/archivo/{{ archivo.id }}">
            <img src="/media/{{ thumb }}" alt="Miniatura">
          </a>
        {% elif archivo.tipo.startswith('audio/') %}
          <img src="{{ url_for('static', filename='icons/audio.png') }}" alt="Audio">
        {% else %}
          <img src="{{ url_for('static', filename='icons/file.png') }}" alt="Archivo">
        {% endif %}
        <small>{{ archivo.tipo }}</small>
        <small>{{ archivo.tama√±o | filesizeformat }}</small>
        <small>üìÖ {{ archivo.fecha_subida.strftime('%Y-%m-%d %H:%M') }}</small>
        <a href="/descargar/{{ archivo.id }}">‚¨áÔ∏è Descargar</a>
      </div>
    {% endfor %}
  </div>
{% else %}
  <p>No hay archivos privados a√∫n.</p>
{% endif %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const input = document.querySelector('input[name="etiqueta"], input[name="q"]');
    const suggestions = document.createElement('ul');

    suggestions.style.position = 'absolute';
    suggestions.style.border = '1px solid #ccc';
    suggestions.style.padding = '5px';
    suggestions.style.backgroundColor = '#fff';
    suggestions.style.zIndex = '1000';
    suggestions.style.listStyle = 'none';
    suggestions.style.marginTop = '5px';
    suggestions.style.maxHeight = '200px';
    suggestions.style.overflowY = 'auto';
    suggestions.style.width = input.offsetWidth + 'px';
    suggestions.hidden = true;

    input.parentNode.appendChild(suggestions);

    input.addEventListener('input', async () => {
        const fullQuery = input.value.trim();
        if (!fullQuery) {
            suggestions.hidden = true;
            return;
        }

        // Obtener √∫ltima palabra (la parcial a completar)
        const palabras = fullQuery.split(/\s+/);
        const ultima = palabras[palabras.length - 1];
        const response = await fetch(`/sugerencias_etiquetas?q=${encodeURIComponent(fullQuery)}`);
        const datos = await response.json();

        suggestions.innerHTML = '';
        if (datos.length === 0) {
            suggestions.hidden = true;
            return;
        }

        datos.forEach(etiqueta => {
            const li = document.createElement('li');
            li.textContent = `${etiqueta.nombre} (${etiqueta.cantidad})`;
            li.style.cursor = 'pointer';
            li.style.padding = '5px';

            li.addEventListener('click', () => {
                // Reemplazar solo la √∫ltima palabra por la sugerencia
                palabras[palabras.length - 1] = etiqueta.nombre;
                input.value = palabras.join(' ') + ' ';
                suggestions.hidden = true;
                input.focus();
            });

            suggestions.appendChild(li);
        });

        const rect = input.getBoundingClientRect();
        suggestions.style.top = input.offsetTop + input.offsetHeight + 'px';
        suggestions.style.left = input.offsetLeft + 'px';
        suggestions.style.width = input.offsetWidth + 'px';
        suggestions.hidden = false;
    });

    document.addEventListener('click', e => {
        if (!suggestions.contains(e.target) && e.target !== input) {
            suggestions.hidden = true;
        }
    });
});
</script>
{% endblock %}
