{% extends "base.html" %}

{% block titulo %}Filtrar por etiqueta{% endblock %}

{% block contenido %}
<h1>Filtrar archivos por etiqueta</h1>

<form action="/buscar" method="GET" style="margin-bottom: 20px;">
    <label for="etiqueta">Etiqueta:</label>
    <input type="text" name="etiqueta" placeholder="ej: trabajo, 2025, im√°genes" required>
    <button type="submit">Buscar</button>
</form>

{% if archivos %}
  <style>
    .galeria {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    .tarjeta {
        background: #f9f9f9;
        border: 1px solid #ddd;
        padding: 12px;
        border-radius: 6px;
        text-align: center;
        box-shadow: 1px 1px 5px rgba(0, 0, 0, 0.05);
        font-family: sans-serif;
    }
    .tarjeta img {
        max-width: 100%;
        max-height: 120px;
        object-fit: contain;
        margin-bottom: 10px;
    }
    .tarjeta a {
        display: block;
        font-weight: bold;
        margin: 4px 0;
        text-decoration: none;
    }
    .tarjeta small {
        color: #666;
        display: block;
        font-size: 0.85em;
    }
  </style>

  <h2>Resultados para '{{ etiqueta_buscada }}'</h2>
  <div class="galeria">
    {% for archivo in archivos %}
      <div class="tarjeta">
        {% if archivo.tipo.startswith('image/') %}
          <img src="/media/thumb_{{ archivo.nombre }}" alt="Miniatura">
        {% else %}
          <img src="/static/img/file-icon.png" alt="Archivo">
        {% endif %}
        <a href="/archivo/{{ archivo.id }}">{{ archivo.nombre }}</a>
        <small>{{ archivo.tipo }}</small>
        <small>{{ archivo.tama√±o }} bytes</small>
        <small>üìÖ {{ archivo.fecha_subida.strftime('%Y-%m-%d %H:%M') }}</small>
        <a href="/descargar/{{ archivo.id }}">Descargar</a>
      </div>
    {% endfor %}
  </div>
{% elif etiqueta_buscada %}
  <p>No se encontraron archivos con la etiqueta '{{ etiqueta_buscada }}'.</p>
{% endif %}

<br>
<a href="/archivos">‚Üê Volver a todos los archivos</a>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const input = document.querySelector('input[name="etiqueta"], input[name="q"]');
    const suggestions = document.createElement('ul');

    suggestions.style.position = 'absolute';
    suggestions.style.border = '1px solid #ccc';
    suggestions.style.padding = '5px';
    suggestions.style.backgroundColor = '#fff';
    suggestions.style.zIndex = '1000';
    suggestions.style.listStyle = 'none';
    suggestions.style.marginTop = '5px';
    suggestions.style.maxHeight = '200px';
    suggestions.style.overflowY = 'auto';
    suggestions.style.width = input.offsetWidth + 'px';
    suggestions.hidden = true;

    input.parentNode.appendChild(suggestions);

    input.addEventListener('input', async () => {
        const fullQuery = input.value.trim();
        if (!fullQuery) {
            suggestions.hidden = true;
            return;
        }

        // Obtener √∫ltima palabra (la parcial a completar)
        const palabras = fullQuery.split(/\s+/);
        const ultima = palabras[palabras.length - 1];
        const response = await fetch(`/sugerencias_etiquetas?q=${encodeURIComponent(fullQuery)}`);
        const datos = await response.json();

        suggestions.innerHTML = '';
        if (datos.length === 0) {
            suggestions.hidden = true;
            return;
        }

        datos.forEach(etiqueta => {
            const li = document.createElement('li');
            li.textContent = `${etiqueta.nombre} (${etiqueta.cantidad})`;
            li.style.cursor = 'pointer';
            li.style.padding = '5px';

            li.addEventListener('click', () => {
                // Reemplazar solo la √∫ltima palabra por la sugerencia
                palabras[palabras.length - 1] = etiqueta.nombre;
                input.value = palabras.join(' ') + ' ';
                suggestions.hidden = true;
                input.focus();
            });

            suggestions.appendChild(li);
        });

        const rect = input.getBoundingClientRect();
        suggestions.style.top = input.offsetTop + input.offsetHeight + 'px';
        suggestions.style.left = input.offsetLeft + 'px';
        suggestions.style.width = input.offsetWidth + 'px';
        suggestions.hidden = false;
    });

    document.addEventListener('click', e => {
        if (!suggestions.contains(e.target) && e.target !== input) {
            suggestions.hidden = true;
        }
    });
});
</script>
{% endblock %}
